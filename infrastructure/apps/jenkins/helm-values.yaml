# Jenkins Helm Chart Values
# Configures Jenkins with JCasC, Kubernetes agents, and GitHub Organization scanning
# Reference: https://github.com/jenkinsci/helm-charts/blob/main/charts/jenkins/VALUES_SUMMARY.md

controller:
  # Container image configuration
  image:
    registry: "docker.io"
    repository: "jenkins/jenkins"
    tag: "${jenkins_image_tag}"
    pullPolicy: "IfNotPresent"

  # Number of controller replicas (should be 1 for stateful app)
  replicas: 1

  # Service ports
  servicePort: 8080
  targetPort: 8080
  agentListenerPort: 50000
  agentListenerServiceType: ClusterIP

  # Resource limits for the controller
  resources:
    requests:
      cpu: "${controller_cpu_request}"
      memory: "${controller_memory_request}"
    limits:
      cpu: "${controller_cpu_limit}"
      memory: "${controller_memory_limit}"

  # Service Account - created by Terraform
  serviceAccount:
    create: false
    name: "jenkins-admin"

  # Skip the setup wizard since we're using JCasC
  javaOpts: "-Djenkins.install.runSetupWizard=false -Dhudson.model.DirectoryBrowserSupport.CSP="

  # Install required plugins
  installPlugins:
    # Core plugins
    - kubernetes:4353.v14a_924f218ec
    - workflow-aggregator:600.vb_57cdd26fdd7
    - git:5.7.0
    - configuration-as-code:1903.v4759a_648de91
    - credentials-binding:681.vf91669a_32e45
    # GitHub integration
    - github-branch-source:1797.v86fdb_4d57d43
    - github:1.40.0
    # Pipeline and job management
    - job-dsl:1.89
    - pipeline-stage-view:2.34
    - pipeline-utility-steps:2.18.0
    # Additional useful plugins
    - docker-workflow:580.vc0c340686b_54
    - timestamper:1.27
    - ws-cleanup:0.46
    - ansicolor:1.0.6
    - matrix-auth:3.2.2

  # Disable additional plugins for cleaner setup
  additionalPlugins: []

  # Jenkins Configuration as Code (JCasC)
  JCasC:
    defaultConfig: false
    configScripts:
      # System configuration
      system-config: |
        jenkins:
          systemMessage: |
            Jenkins CI/CD Server
            Configured automatically by JCasC and Terraform
            GitHub Organization: https://github.com/${github_organization}
          numExecutors: 0
          mode: EXCLUSIVE
          quietPeriod: 5
          scmCheckoutRetryCount: 3
          
        unclassified:
          location:
            url: "https://${ingress_host}/"
            adminAddress: "admin@${ingress_host}"

      # Security configuration
      security-config: |
        jenkins:
          securityRealm:
            local:
              allowsSignup: false
              users:
                - id: "admin"
                  name: "Administrator"
                  password: "$${JENKINS_ADMIN_PASSWORD:-admin}"
          authorizationStrategy:
            loggedInUsersCanDoAnything:
              allowAnonymousRead: false
          remotingSecurity:
            enabled: true

      # Kubernetes cloud configuration for dynamic agents
      kubernetes-cloud: |
        jenkins:
          clouds:
            - kubernetes:
                name: "kubernetes"
                serverUrl: "https://kubernetes.default.svc.cluster.local"
                skipTlsVerify: false
                namespace: "${namespace}"
                jenkinsUrl: "http://jenkins.${namespace}.svc.cluster.local:8080"
                jenkinsTunnel: "jenkins-agent.${namespace}.svc.cluster.local:50000"
                connectTimeout: 5
                readTimeout: 15
                containerCapStr: "${agent_max_instances}"
                maxRequestsPerHostStr: 32
                retentionTimeout: 5
                podRetention: "never"
                
                templates:
                  # Default JNLP agent template
                  - name: "default"
                    label: "jenkins-agent linux"
                    nodeUsageMode: NORMAL
                    serviceAccount: "jenkins-admin"
                    podRetention: "never"
                    idleMinutes: 10
                    activeDeadlineSeconds: 7200
                    slaveConnectTimeout: 300
                    
                    containers:
                      - name: "jnlp"
                        image: "jenkins/inbound-agent:latest-jdk17"
                        alwaysPullImage: false
                        workingDir: "/home/jenkins/agent"
                        ttyEnabled: true
                        resourceRequestCpu: "${agent_cpu_request}"
                        resourceRequestMemory: "${agent_memory_request}"
                        resourceLimitCpu: "${agent_cpu_limit}"
                        resourceLimitMemory: "${agent_memory_limit}"
                        envVars:
                          - envVar:
                              key: "JENKINS_URL"
                              value: "http://jenkins.${namespace}.svc.cluster.local:8080"
                    
                    # Ephemeral storage for agents
                    volumes:
                      - emptyDirVolume:
                          memory: false
                          mountPath: "/tmp"
                      - emptyDirVolume:
                          memory: false
                          mountPath: "/home/jenkins/agent"
                    
                    yaml: |
                      spec:
                        securityContext:
                          runAsUser: 1000
                          runAsGroup: 1000
                          fsGroup: 1000
                        tolerations:
                          - key: "node.kubernetes.io/not-ready"
                            operator: "Exists"
                            effect: "NoExecute"
                            tolerationSeconds: 300

                  # Docker-in-Docker agent for container builds
                  - name: "docker"
                    label: "docker dind"
                    nodeUsageMode: EXCLUSIVE
                    serviceAccount: "jenkins-admin"
                    podRetention: "never"
                    idleMinutes: 5
                    activeDeadlineSeconds: 3600
                    slaveConnectTimeout: 300
                    
                    containers:
                      - name: "jnlp"
                        image: "jenkins/inbound-agent:latest-jdk17"
                        alwaysPullImage: false
                        workingDir: "/home/jenkins/agent"
                        ttyEnabled: true
                        resourceRequestCpu: "${agent_cpu_request}"
                        resourceRequestMemory: "${agent_memory_request}"
                        resourceLimitCpu: "${agent_cpu_limit}"
                        resourceLimitMemory: "${agent_memory_limit}"
                      
                      - name: "docker"
                        image: "docker:dind"
                        privileged: true
                        ttyEnabled: true
                        resourceRequestCpu: "250m"
                        resourceRequestMemory: "256Mi"
                        resourceLimitCpu: "1000m"
                        resourceLimitMemory: "1Gi"
                    
                    volumes:
                      - emptyDirVolume:
                          memory: false
                          mountPath: "/tmp"
                      - emptyDirVolume:
                          memory: false
                          mountPath: "/home/jenkins/agent"
                      - emptyDirVolume:
                          memory: false
                          mountPath: "/var/lib/docker"

      # GitHub Organization Folder configuration via Job DSL
      github-org-seed: |
        jobs:
          - script: >
              organizationFolder('${github_organization}') {
                description('GitHub Organization: https://github.com/${github_organization}')
                displayName('GitHub - ${github_organization}')
                
                organizations {
                  github {
                    apiUri('https://api.github.com')
                    repoOwner('${github_organization}')
                    credentialsId('${github_credentials_id}')
                    
                    traits {
                      gitHubBranchDiscovery {
                        strategyId(1)
                      }
                      gitHubPullRequestDiscovery {
                        strategyId(1)
                      }
                      gitHubForkDiscovery {
                        strategyId(1)
                        trust {
                          gitHubTrustPermissions()
                        }
                      }
                      gitHubTagDiscovery()
                      sourceWildcardFilter {
                        includes('*')
                        excludes('')
                      }
                    }
                  }
                }
                
                configure { node ->
                  def traits = node / navigators / 'org.jenkinsci.plugins.github__branch__source.GitHubSCMNavigator' / traits
                  
                  traits << 'jenkins.scm.impl.trait.RegexSCMSourceFilterTrait' {
                    regex('${github_repo_regex}')
                  }
                  
                  def triggers = node / triggers
                  triggers << 'com.cloudbees.hudson.plugins.folder.computed.PeriodicFolderTrigger' {
                    spec('H/${github_scan_interval} * * * *')
                    interval(${github_scan_interval} * 60 * 1000)
                  }
                }
                
                projectFactories {
                  workflowMultiBranchProjectFactory {
                    scriptPath('Jenkinsfile')
                  }
                }
                
                orphanedItemStrategy {
                  discardOldItems {
                    daysToKeep(30)
                    numToKeep(50)
                  }
                }
                
                buildStrategies {
                  buildRegularBranches()
                  buildChangeRequests {
                    ignoreTargetOnlyChanges(true)
                    ignoreUntrustedChanges(false)
                  }
                  buildTags {
                    atLeastDays('-1')
                    atMostDays('7')
                  }
                }
              }

  # Ingress configuration
  ingress:
    enabled: true
    ingressClassName: "${ingress_class_name}"
    hostName: "${ingress_host}"
    annotations:
      traefik.ingress.kubernetes.io/router.entrypoints: "websecure"
      traefik.ingress.kubernetes.io/router.tls: "true"
    tls:
      - secretName: jenkins-tls
        hosts:
          - "${ingress_host}"

  # Probes
  healthProbes: true
  probes:
    startupProbe:
      httpGet:
        path: "/login"
        port: http
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 12
    livenessProbe:
      httpGet:
        path: "/login"
        port: http
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 5
    readinessProbe:
      httpGet:
        path: "/login"
        port: http
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 3

# Persistence configuration - uses existing PVC created by Terraform
persistence:
  enabled: true
  existingClaim: "jenkins-pvc"

# Agent configuration - disabled as we configure via JCasC
agent:
  enabled: false

# Network Policy
networkPolicy:
  enabled: false

# RBAC - created separately in Terraform
rbac:
  create: false
  readSecrets: true

# Service Account - created separately in Terraform
serviceAccount:
  create: false
  name: "jenkins-admin"
